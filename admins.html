<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>NO-CODE</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="users.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Мои задачи</h1>
      </header>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-number" id="total-tasks">0</div>
          <div class="stat-label">Всего задач</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="completed-tasks">0</div>
          <div class="stat-label">Выполнено</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="progress-percent">0%</div>
          <div class="stat-label">Прогресс</div>
        </div>
      </div>

      <div class="section-title">
        <i class="fas fa-tasks"></i> Активные задачи
      </div>

      <div id="tasks-container">
        <!-- Задачи будут добавляться сюда -->
      </div>

      <div class="section-title">
        <i class="fas fa-check-circle"></i> Завершенные задачи
      </div>

      <div id="completed-tasks-container">
        <!-- Завершенные задачи будут добавляться сюда -->
      </div>
    </div>

    <div class="add-task-btn" id="add-task-btn">
      <i class="fas fa-plus"></i>
    </div>
    <script>
      // Данные задач
      let tasks = [
        {
          id: 1,
          title: "Ремонт конвейра",
          description:
            "Проверить систему конверов разлива-сборки тары",
          category: "СРОЧНО",
          markers: [
            { id: 1, text: "Проверка соединений", completed: true },
            { id: 2, text: "Снятия оснастки", completed: true },
            { id: 3, text: "Добавление рекоструриования", completed: true },
            { id: 4, text: "Перепрограмирование", completed: false },
            { id: 5, text: "Тестирование", completed: false },
            { id: 6, text: "Заполнение документации", completed: false },
          ],
          date: "2023-10-15",
          completed: false,
        },
        {
          id: 2,
          title: "Контрольная закупка",
          description: "Проверить наличие товара",
          category: "Планова",
          markers: [
            { id: 1, text: "Составить список", completed: true },
            { id: 2, text: "Купить овощи", completed: true },
            { id: 3, text: "Купить молочные продукты", completed: false },
            { id: 4, text: "Купить мясо и рыбу", completed: false },
          ],
          date: "2023-10-12",
          completed: false,
        },
        {
          id: 3,
          title: "Планирование отпуска",
          description: "Спланировать поездку на море на следующий месяц",
          category: "Личное",
          markers: [
            { id: 1, text: "Выбрать даты", completed: true },
            { id: 2, text: "Забронировать отель", completed: true },
            { id: 3, text: "Купить билеты", completed: true },
            { id: 4, text: "Составить маршрут", completed: true },
          ],
          date: "2023-10-05",
          completed: true,
        },
      ];

      // Инициализация при загрузке страницы
      document.addEventListener("DOMContentLoaded", function () {
        renderTasks();
        updateStats();

        // Обработчик кнопки добавления задачи
        document
          .getElementById("add-task-btn")
          .addEventListener("click", addNewTask);
      });

      // Функция для отрисовки задач
      function renderTasks() {
        const tasksContainer = document.getElementById("tasks-container");
        const completedContainer = document.getElementById(
          "completed-tasks-container"
        );

        // Очищаем контейнеры
        tasksContainer.innerHTML = "";
        completedContainer.innerHTML = "";

        // Разделяем задачи на активные и завершенные
        const activeTasks = tasks.filter((task) => !task.completed);
        const completedTasks = tasks.filter((task) => task.completed);

        // Отображаем активные задачи
        if (activeTasks.length > 0) {
          activeTasks.forEach((task) => {
            tasksContainer.appendChild(createTaskElement(task));
          });
        } else {
          tasksContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Нет активных задач. Добавьте новую!</p>
                    </div>
                `;
        }

        // Отображаем завершенные задачи
        if (completedTasks.length > 0) {
          completedTasks.forEach((task) => {
            completedContainer.appendChild(createTaskElement(task));
          });
        } else {
          completedContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <p>Нет завершенных задач</p>
                    </div>
                `;
        }
      }

      // Создание элемента задачи
      function createTaskElement(task) {
        const taskElement = document.createElement("div");
        taskElement.className = "task-block";
        taskElement.dataset.id = task.id;

        // Расчет прогресса
        const completedMarkers = task.markers.filter(
          (marker) => marker.completed
        ).length;
        const totalMarkers = task.markers.length;
        const progressPercent =
          totalMarkers > 0
            ? Math.round((completedMarkers / totalMarkers) * 100)
            : 0;

        // Определение цвета прогресс-бара
        let progressBarClass = "low-progress";
        if (progressPercent >= 100) {
          progressBarClass = "complete-progress";
        } else if (progressPercent >= 70) {
          progressBarClass = "high-progress";
        } else if (progressPercent >= 40) {
          progressBarClass = "medium-progress";
        }

        // Форматирование даты
        const formattedDate = new Date(task.date).toLocaleDateString("ru-RU", {
          day: "numeric",
          month: "long",
        });

        taskElement.innerHTML = `
                <div class="task-header">
                    <div class="task-title">${task.title}</div>
                    <div class="task-category">${task.category}</div>
                </div>
                <div class="task-description">${task.description}</div>
                <div class="task-date">Срок: ${formattedDate}</div>
                <div class="task-progress">
                    <div class="progress-bar">
                        <div class="progress-fill ${progressBarClass}" style="width: ${progressPercent}%"></div>
                    </div>
                    <div class="progress-text">${progressPercent}%</div>
                </div>
                <div class="task-markers" id="markers-${task.id}">
                    ${task.markers
                      .map(
                        (marker) => `
                        <div class="marker ${
                          marker.completed ? "complete" : "incomplete"
                        }" 
                             data-marker-id="${marker.id}" 
                             data-task-id="${task.id}">
                            <span class="marker-icon">
                                ${
                                  marker.completed
                                    ? '<i class="fas fa-check-circle"></i>'
                                    : '<i class="far fa-circle"></i>'
                                }
                            </span>
                            <span class="marker-text">${marker.text}</span>
                        </div>
                    `
                      )
                      .join("")}
                </div>
                <div class="task-actions">
                    <div class="action-btn edit-btn" onclick="toggleTaskComplete(${
                      task.id
                    })">
                        <i class="fas ${
                          task.completed ? "fa-undo" : "fa-check"
                        }"></i>
                        <span>${task.completed ? "Вернуть" : "Завершить"}</span>
                    </div>
                    <div class="action-btn delete-btn" onclick="deleteTask(${
                      task.id
                    })">
                        <i class="fas fa-trash"></i>
                        <span>Удалить</span>
                    </div>
                </div>
            `;

        // Добавляем обработчики для маркеров
        const markers = taskElement.querySelectorAll(".marker");
        markers.forEach((marker) => {
          marker.addEventListener("click", function () {
            const taskId = parseInt(this.dataset.taskId);
            const markerId = parseInt(this.dataset.markerId);
            toggleMarker(taskId, markerId);
          });
        });

        return taskElement;
      }

      // Переключение состояния маркера
      function toggleMarker(taskId, markerId) {
        const task = tasks.find((t) => t.id === taskId);
        if (!task) return;

        const marker = task.markers.find((m) => m.id === markerId);
        if (marker) {
          marker.completed = !marker.completed;
          renderTasks();
          updateStats();
        }
      }

      // Переключение состояния задачи (выполнена/не выполнена)
      function toggleTaskComplete(taskId) {
        const task = tasks.find((t) => t.id === taskId);
        if (task) {
          task.completed = !task.completed;
          renderTasks();
          updateStats();
        }
      }

      // Удаление задачи
      function deleteTask(taskId) {
        if (confirm("Вы уверены, что хотите удалить эту задачу?")) {
          tasks = tasks.filter((t) => t.id !== taskId);
          renderTasks();
          updateStats();
        }
      }

      // Обновление статистики
      function updateStats() {
        const totalTasks = tasks.length;
        const completedTasks = tasks.filter((task) => task.completed).length;
        const totalMarkers = tasks.reduce(
          (sum, task) => sum + task.markers.length,
          0
        );
        const completedMarkers = tasks.reduce((sum, task) => {
          return sum + task.markers.filter((marker) => marker.completed).length;
        }, 0);

        const progressPercent =
          totalMarkers > 0
            ? Math.round((completedMarkers / totalMarkers) * 100)
            : 0;

        document.getElementById("total-tasks").textContent = totalTasks;
        document.getElementById("completed-tasks").textContent = completedTasks;
        document.getElementById(
          "progress-percent"
        ).textContent = `${progressPercent}%`;
      }

      // Добавление новой задачи
      function addNewTask() {
        const newTaskId =
          tasks.length > 0 ? Math.max(...tasks.map((t) => t.id)) + 1 : 1;
        const newTask = {
          id: newTaskId,
          title: "Новая задача",
          description: "Описание новой задачи",
          category: "Личное",
          markers: [
            { id: 1, text: "Первый шаг", completed: false },
            { id: 2, text: "Второй шаг", completed: false },
          ],
          date: new Date().toISOString().split("T")[0],
          completed: false,
        };

        tasks.unshift(newTask);
        renderTasks();
        updateStats();

        // Прокручиваем к новой задаче
        setTimeout(() => {
          const taskElement = document.querySelector(
            `[data-id="${newTaskId}"]`
          );
          if (taskElement) {
            taskElement.scrollIntoView({ behavior: "smooth", block: "center" });

            // Добавляем анимацию выделения
            taskElement.style.boxShadow = "0 0 0 3px rgba(74, 111, 165, 0.5)";
            setTimeout(() => {
              taskElement.style.boxShadow = "";
            }, 2000);
          }
        }, 100);
      }
    </script>
  </body>
</html>
